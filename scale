#!/bin/bash
app=2
last_ip="172.17.0.3"
threshold=50
while true; do
	cpuUsage=()
	cpuUsage=( $(sudo docker stats --no-stream | awk '{print $2}') )
	#echo ${cpuUsage[@]:1}
	for i in "${cpuUsage[@]:1}"
		do
			cur_cpu=${i::-1}
			cmp=$(echo "$cur_cpu>$threshold" | bc)
			if [ $cmp -eq 1 ];
			then
				app=$(echo "$app+1"|bc)
				sudo docker run --name running_apache$app --rm -it my-apache2
				baseaddr="$(echo $last_ip | cut -d. -f1-3)"
				lsv="$(echo $ip | cut -d. -f4)"
				lsv=$(echo "$lsv+1"|bc)
				last_ip=$baseaddr.$lsv
				new_server="server $app-www $last_ip:80 check"
				sudo echo $new_server >> /etc/haproxy/haproxy.cfg
				sudo systemctl restart haproxy.service
			fi
	sleep 2
		done
done
